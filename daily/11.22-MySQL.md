# mysql 

## 设计表的三大范式

1. 不可拆分，并且无重复列，保证列满足原子性
2. 满足 1 ，并且除主键外每一列都必须依靠主键
3. 满足 2 ，并且除主键外每一列都不能相互依赖

## select * 与 select 所有列

- 如果是取所有列，在性能上没有任何差别
- 把所有列名列出来，会让代码易读
- 当表格修改，尤其删除列的时候，select 所有列会报错，需要修改代码适配，能避免一些潜在的问题
- 如果只需要某几个字段，select * 要多消耗资源，如果只需要一个带索引的字段，在执行时间上会有很大的差异

## mysql 优化

查询优化：

- 开启慢查询日志，收集慢查询的语句，通过 explain 分析慢查询语句，进行优化；
- 尽量避免全表扫描，在 where 以及 order by 涉及到的列上建立索引，或者联合索引，注意控制索引数量，否则会影响插入修改的效率；
- 不要使用 select * ,用到哪些字段，选择哪些字段
- 如果可以，尽可能不使用 null 

## 创建索引的原则

- 排序、分组、联合查询频率高的字段创建索引
- 索引数目不宜过多，过多会影响 insert update delete 效率

## 索引失效的条件

- 不在索引列上做操作
- 联合索引没有使用最左边的一列
- 使用不等于，is null 的时候
- like 以通配符开头的时候

## 聚簇索引和非聚簇索引

- 聚簇索引，将数据与索引放到一块儿，找到索引也就找到了数据
- 非聚簇索引，将数据与索引分开存储，索引的叶子节点，存储数据行的指针

聚簇索引特点：

- 聚簇索引对于主键的排序查找和范围查找速度快；
- 插入速度严重依赖于插入顺序，按照主键的插入是最快的方式，否则会出现页分裂，严重影响性能；
- 更新主键的代价很高，因为将会导致被更新的行移动；

非聚簇索引：

- 需要两次查找；
- 如果涉及到大数据量的排序、全表扫描、count 之类的操作的话，因为索引所占空间小，这些操作在内存中完成，效率要高。

## mysql 执行计划

mysql sql 执行计划通过 explain 查看，执行计划返回的信息有：

- id
- select_type 查询类型，区分简单查询，联合查询，子查询等
- table 查询的表
- type，执行类型

  - ALL 全表扫描
  - INDEX 全索引扫描
  - RANGE 索引范围查询
  - REF 使用索引等值查询
  - EQ_REF 主键或者唯一键
  - CONST 表中数据最多一条
  - SYSTEM

- possible_key : 可能用到的索引
- key ：用到的索引
- key_len : 索引的长度
- ref: 索引字段关联字段
- rows: 估算出的扫描行数，越小越好
- filtered : 返回行数占读取行数的百分比
- extra: using filesort 使用文件排序，没有使用索引排序，using index 使用了索引覆盖不需要回表 ,using where，using temporary 使用临时表

## MySQL 存储文件

todo

## MySQL B+ 树深度计算

- InnoDB 存储引擎默认的页大小为 16K
- 存储页的结构

  - Fil head 38 字节
  - page head 56 字节
  - 记录上下限 26 个字节
  - 记录
  - free
  - page dictionary 6 条记录一个位置，占用 2 个字节
  - Fil trailer 8 字节

- record 结构

  - start offset  1 - 2 字节，小于 127 字节的记录使用 1 字节，大于的使用 2 个字节
  - extra 固定 6 字节
  - contents

记录分多种：

- 数据行记录
- 主键索引记录
- 二级索引记录

- 主键索引结构

  - 主键索引列，跟索引类型相关
  - 下级页的位置 4 字节

- 二级索引

  - 索引列
  - 下级页的位置
  - 主键索引列

- 数据行记录

  - 占用的空间依赖与 row format
  - row format 类型：默认是 dynamic 其他的有冗余 紧凑 动态 压缩，动态的比紧凑的添加了变长列存储增强，长索引前缀支持，最长支持到 3K
  - row format 的存储会区分变长定长，变长的如果超过 768 字节就会存储到其他地方，页里面只保存 20 字节的地址，数据列是够可以为 null 也会占用 1 bit 的空间，不足 1 字节的占用 1 字节，text blob 如果大小小于 40 字节，会存储在记录内

- InnoDB 会预留 page 的 1/16 ,留作后续扩展使用，有序的插入 page 的使用率可以达到 15/16 ，无序的插入使用率在 1/2 - 15/16 之间
- InnoDB 主键索引，叶子节点存储数据，非叶子节点存储主键索引。
- 以 int 类型的主键为例，主键索引记录占用的字节数为 4字节主键存储空间 + 1 字节 start offset + 6 字节的 extra bytes + 4 字节的下级地址 = 15 字节
- page 默认 16K ，预留 1K 只能使用 15K ，减去头尾固定开销 100 多字节，留给 record 和 page dictionary 的差不多是 15K ，一个 page 存储的索引数量在 1000 左右
- 深度和数据的对应关系，非叶子节点的层数 n , 1 页存储的行数 r ,最多可以存储的数据行数 rows = 1000^n * r

